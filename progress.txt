# Watercolor Mahjong — Progress Log

## Previous Sprint Summary
Ralph completed two full PRD sprints overnight:
- Sprint 1: 5-layer Turtle layout, stuck detection, win celebration with birthday message, hint/undo/shuffle, progress indicator, match animations, birthday dedication screen, mobile responsiveness
- Sprint 2: Tile redesign (paintings replacing symbols with variant number badges), audio implementation (mute toggle, background music, sound effects)

## Known Issues Going Into This Sprint
- PWA icon has harsh white background — needs warm cream (#FDF8F0) to match game aesthetic
- Mobile viewport: board scales too small to fit screen — tiles are ~25-30px and untappable. Need zoomed-in scrollable view instead.
- Playable vs blocked tiles: visual contrast is insufficient — hard to tell which tiles are interactive at a glance
- Audio uses Web Audio API synthesized oscillator tones that sound like buzzing — need real mp3 files instead

## Learnings From Previous Sprints
- Tile component structure: button.tile with child divs for overlay, watercolor background, gradient, and content
- Blocked state: applied via `blocked` CSS class on the button element
- Tailwind CSS is the styling framework — use utility classes
- PWA viewport meta already set: `width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no`
- Theme color: #9B8BB8 (purple)
- Board uses absolute positioning for tiles
- 9 watercolor painting assets mapped to tile suits, 4 variants each, 4 copies = 144 tiles
- Audio system exists with mute toggle and localStorage persistence — needs mp3 file swap, not a rewrite
- Icon assets are in the public directory — check for existing generation scripts or source files
- The game's cream/off-white background color is approximately #FDF8F0

---

## Iteration 1 - PWA Icon — Warm Cream Background
- Generated new icon files with cream (#FDF8F0) background using Python/Pillow
- Created: icon-192.png (192x192), icon-512.png (512x512), apple-touch-icon.png (180x180), favicon.ico (32x32)
- Source: logo_tile_icon.png (500x500) composited onto cream background, converted to RGB (no alpha)
- Updated vite.config.js manifest icons to reference properly-sized icon files instead of logo_tile_icon.png
- Updated index.html with favicon.ico, sized icon links, and apple-touch-icon reference
- Manifest background_color was already #FDF8F0, theme_color stays #9B8BB8 (purple for status bar)
- Files changed: public/icons/icon-192.png, public/icons/icon-512.png, public/icons/apple-touch-icon.png, public/favicon.ico, vite.config.js, index.html, PRD.md
- Learnings for future iterations:
  - Vite copies public/ contents to dist/ at root level — favicon.ico goes in public/ not public/icons/
  - No test/typecheck scripts — `npm run build` is the only verification
  - logo_tile_icon.png is a hydrangea tile with transparency around rounded rect shape — the cream fill eliminates white gaps
  - icon-192.png and icon-512.png were previously different artwork (lilac) — now they match the primary logo_tile_icon
---

## Iteration 2 - Mobile Board — Zoomed-In Scrollable View
- On mobile (<768px), tiles now render at 55px wide (73px tall) instead of scaling down to fit viewport
- Board container switches from `overflow: hidden` (desktop) to `overflow: auto` (mobile) for touch scrolling
- Added `-webkit-overflow-scrolling: touch` and `overscroll-behavior: contain` for smooth iOS momentum scroll
- Hidden scrollbars on mobile for clean aesthetic (scrollbar-width: none, ::-webkit-scrollbar display: none)
- Board auto-centers on initial load via `scrollTo()` in a requestAnimationFrame callback
- Auto-center resets on new game (tracks via tiles.length change)
- 20px margin around board on mobile so edges are reachable when scrolled
- Desktop behavior is completely unchanged — still fits board in viewport
- Fixed header and bottom control bar remain fixed and visible (already implemented via fixed positioning in App.jsx)
- Files changed: src/components/Board.jsx, src/index.css, PRD.md, progress.txt
- Learnings for future iterations:
  - Board bounds: width ~15.5 tile-widths, height ~8.5 tile-heights, 5 layers
  - At 55px tile width: board is ~863px wide, ~645px tall — requires scrolling on 375px screens
  - `body { overflow: hidden }` on root does NOT prevent `overflow: auto` on child containers from scrolling
  - `touch-action: manipulation` on body still allows scroll gestures within scrollable children
  - The mobile bottom bar is ~80px total (progress row + controls row), header ~50px
  - `isMobile` state tracks viewport width and switches rendering strategy dynamically on resize
---

## Iteration 3 - Playable vs Blocked Tile Contrast
- Most of the styling was already implemented in a previous iteration (likely during Sprint 2 tile redesign)
- Open tiles: opacity 1, lifted shadow, translateY(-1px), pointer cursor — already correct
- Blocked tiles: dimmed, flat, desaturated, no transform, default cursor — already correct
- Hover states: properly wrapped in @media (hover: hover) and (pointer: fine), excluded from blocked tiles — already correct
- Shake animation on blocked click: keyframe + handler in App.jsx + shakingId state — already correct
- State transition: 300ms ease-out transition on .tile base class — already correct
- TWO small refinements applied:
  - Blocked opacity: 0.5 → 0.45 (PRD spec for starker contrast)
  - Blocked filter: added brightness(0.9) alongside existing grayscale(30%)
- Files changed: src/index.css, PRD.md, progress.txt
- Learnings for future iterations:
  - The tile visual system was mostly built during Sprint 2 — check existing CSS before assuming work is needed
  - All tile states (selected, blocked, hinted, mismatch, shaking) use CSS classes toggled by React props
  - No test/typecheck scripts — `npm run build` is the only verification (confirmed again)
---

## Iteration 4 - Replace Synthesized Audio with Real Music Files
- Completely rewrote src/hooks/useAudio.js — removed ALL Web Audio API code (AudioContext, oscillators, createGain, createBuffer, etc.)
- New implementation uses HTML5 Audio with `new Audio()` for all sound playback
- Preloads 5 mp3 files on mount: background.mp3, select.mp3, match.mp3, mismatch.mp3, win.mp3
- Background music: loops continuously at volume 0.3, starts on unmute, pauses on mute
- Sound effects: fire-and-forget via cloneNode() for overlapping playback support
- Win sound: fades out background music over ~1s (10 steps via setInterval), then plays win.mp3 at 0.6 volume
- Mute toggle: defaults to muted, persists via localStorage key 'watercolor-mahjong-muted' (unchanged)
- iOS Safari: play() calls wrapped in .catch() to handle autoplay restrictions silently
- If audio files are missing (public/audio/ doesn't exist yet): game runs silently, console warning logged
- No changes needed in App.jsx or GameControls.jsx — the useAudio hook API (return signature) is identical
- Files changed: src/hooks/useAudio.js, PRD.md, progress.txt
- Learnings for future iterations:
  - The hook's return API { muted, toggleMute, playSelect, playMatchSound, playMismatchSound, playWinSound } is stable — callers don't need updating when internals change
  - HTML5 Audio cloneNode() is the simplest way to allow overlapping sound effects without managing a pool
  - Audio files go in public/audio/ and are referenced as '/audio/filename.mp3' (Vite serves public/ at root)
  - `npm run build` is still the only verification (no test suite)
---

## Iteration 5 - Final Mobile QA Pass
- Systematic code review of all components against the QA checklist (18 items)
- Found and fixed 3 issues:
  1. `#root { width: 100vw }` → `width: 100%` — 100vw includes scrollbar width, causing horizontal overflow on mobile
  2. Mobile bottom bar padding `pb-14` (56px) → `pb-[72px]` — bottom bar is ~68-70px tall, tiles were being hidden behind it
  3. AuthUI email input: added `maxWidth: '40vw'` and `min-w-0` + `flex-wrap` so expanded sign-in form doesn't overflow on narrow mobile screens
- All other checklist items verified correct:
  - Landing page + "Begin Journey" button: 44px min-height, fixed overlay ✓
  - Dedication screen + "Start Playing" button: 44px min-height ✓
  - Board at 55px mobile tile width (>50px minimum) ✓
  - Touch scrolling with -webkit-overflow-scrolling: touch ✓
  - Tile selection via click handler on Tile buttons ✓
  - Match removal with 600ms dissolve animation ✓
  - Open vs blocked tile contrast (opacity 0.45, grayscale, brightness) ✓
  - Hint pulse animation with 3s auto-dismiss ✓
  - Undo restores last pair ✓
  - Shuffle rearranges remaining tiles ✓
  - New Game resets everything ✓
  - Progress bar in mobile bottom bar ✓
  - Stuck detection with overlay ✓
  - Win celebration with birthday message and confetti ✓
  - Mute toggle defaults muted, persists via localStorage ✓
  - All buttons ≥ 44×44px tap targets ✓
  - Decorative backgrounds contained in overflow-hidden ✓
  - PWA manifest with cream background color ✓
- Files changed: src/index.css, src/App.jsx, src/components/AuthUI.jsx, PRD.md, progress.txt
- Learnings for future iterations:
  - Never use 100vw for width — it includes scrollbar width on some browsers. Use 100% instead.
  - When using fixed bottom bars on mobile, measure actual bar height (including all rows + padding + border) and set padding-bottom accordingly
  - AuthUI form needs responsive constraints since it renders in the cramped mobile bottom bar
  - `npm run build` is the only verification (no test suite)
---
